---
layout: post
title:  "MySQL为什么会选错索引？"
date:   2020-07-05 20:43:57 +0100
---
1. **MySQL为什么会选错索引？**    
- MySQL是可以拥有多个索引的，然而写sql的时候一般是不会直接指定某个索引的，也就是说，使用那个索引是MYSQL自己决定的。
- 但是有可能一条本可以执行的很快的语句，在极端情况下会执行的很慢。
- 选择索引是优化器的工作。
- 目的是为了找到一个最优方案，以最小的代价完成本次查询（扫描行数，是否使用临时表，是否排序，回表次数等）
- MySQL是根据统计信息来估算记录行数。（采样评估）
- 统计信息就是索引的区分度，一个索引上不同的值越多，这个索引的区分度也就越好，而一个索引上的不同值的个数，称为索引的基数。
- 采样统计：整张表一行行的统计，代价太大了，InnoDB会选择N个数据页，统计页面上的不同值，求出平均值再乘以总页数，得到大概的基数，当变更的行数超过1/M时，会触发一次新的索引统计。（N20M10，N8M16）
- 选错索引的根本原因：
因为索引基数（采样统计不准造成的问题）analyze table t;        
错误的判断扫描行数     
估算查询的代价错误     
select * from t where a between 10000 and 20000; (如果因为害怕查询a回表造成使用主键索引的话，可能还会变慢)       
select * from t force(a) where a between 10000 and 20000;（极端情况下，a可能只有一个10001的值）     
- 选错索引之后的应对方案
使用force index强制指定     
analyze table重新计算表的索引基数统计信息     
修改sql引导优化器选择对的索引（不推荐）     
应对某些特殊场景，新建一个更适合的索引供优化器选择      
删除掉一个被误选择的索引（极端，且必须确认那个索引是真的无效）     
2. **如何给String字符串加索引？**    
- index1(email) 整个字段作为索引存储
- index(email(6))取字段的前6位作为索引存储（前缀索引）
- 使用前缀索引，有可能导致扫描行数增加，查询次数变多，但是节省空间
- 在使用前缀索引时，定义好长度，可以做到既节省空间，又不用额外增加太多的查询成本
- 如何定义长度？（区分度越高越好，意味着重复的值变少。可以通过统计索引上有多少个不同的值来判断使用多长的前缀）
- select count(distinct email) as E from user;
- select count(distinct left(email,4)) as E4 from user;
- 前缀索引对覆盖索引的影响
select id,email from user where email = 'aaa';        
此时如果是前缀索引，会回表确认email的值，导致覆盖索引失效。既是前缀索引取20位，包含了email的所有信息，还是会回到id索引上在查一下，因为InnoDB不能确定前缀索引的定义是否截断了完整信息          
- 四种方式为字符串加索引 
直接创建完整索引，会比较占用空间       
创建前缀索引，比较节省空间，但可能增加查询次数，并且不能使用覆盖索引的优化功能       
倒序存储，再创建前缀索引，可以绕过某些字符串本身前缀的区分度不够问题（身份证号码），但是它不支持范围查询        
创建hash字段索引，查询性能稳定，有额外的存储和计算消耗，不支持使用范围扫描。   