---
layout: post
title:  "消息积压了该如何处理？"
date:   2021-02-16 20:43:57 +0100
---
🍊 消息积压的直接原因，一般是系统中的某个部分出现了性能问题，来不及处理上游发送的消息，才会导致消息积压。所以，发生这种情况一般先来分析下，在使用消息队列时，如何来优化代码的性能，避免出现消息积压。然后再来看看，如果线上系统出现了消息积压，该如何进行紧急处理，最大程度地避免消息积压对业务的影响。
1. **优化性能来避免消息积压**      
对于绝大多数使用消息队列的业务来说，消息队列本身的处理能力要远大于业务系统的处理能力。主流消息队列的单个节点，消息收发的性能可以达到每秒钟处理几万至几十万条消息的水平，还可以通过水平扩展 Broker 的实例数成倍地提升处理能力。而一般的业务系统需要处理的业务逻辑远比消息队列要复杂，单个节点每秒钟可以处理几百到几千次请求，已经可以算是性能非常好的了。所以，对于消息队列的性能优化，关注的应该是，在消息的收发两端，业务代码怎么和消息队列配合，达到一个最佳的性能。      
（1）发送端性能优化      
- Producer 发消息给 Broker，Broker 收到消息后返回确认响应，这是一次完整的交互。假设这一次交互的平均时延是 1ms，我们把这 1ms 的时间分解开，它包括了下面这些步骤的耗时：     
1） 发送端准备数据、序列化消息、构造请求等逻辑的时间，也就是发送端在发送网络请求之前的耗时；     
2） 发送消息和返回响应在网络传输中的耗时；    
3） Broker 处理消息的时延。       
无论是增加每次发送消息的批量大小，还是增加并发，都能成倍地提升发送性能。至于到底是选择批量发送还是增加并发，主要取决于发送端程序的业务性质。简单来说，只要能够满足性能要求，怎么实现方便就怎么实现。     

（2）消费端性能优化
使用消息队列的时候，大部分的性能问题都出现在消费端，如果消费的速度跟不上发送端生产消息的速度，就会造成消息积压。如果这种性能倒挂的问题只是暂时的，那问题不大，只要消费端的性能恢复之后，超过发送端的性能，那积压的消息是可以慢慢被消费掉的。要是消费速度一直比生产速度慢，时间长了，整个系统就会出现问题，要么，消息队列的存储被填满无法提供服务，要么消息丢失。     
所以，一定要保证消费端的消费性能要高于生产端的发送性能，这样的系统才能健康的持续运行。    
- 消费端的性能优化除了优化消费业务逻辑以外，也可以通过水平扩容，增加消费端的并发数来提升总体的消费性能。特别需要注意的一点是，在扩容 Consumer 的实例数量的同时，必须同步扩容主题中的分区（也叫队列）数量，确保 Consumer 的实例数和分区数量是相等的。

2. **消息积压了该如何处理？**
还有一种消息积压的情况是，在某一个时刻，突然就开始积压消息并且积压持续上涨。这种情况下需要你在短时间内找到消息积压的原因，迅速解决问题才不至于影响业务。能导致积压突然增加，最粗粒度的原因，只有两种：要么是发送变快了，要么是消费变慢了。大部分消息队列都内置了监控的功能，只要通过监控数据，很容易确定是哪种原因。如果是单位时间发送的消息增多，短时间内不太可能优化消费端的代码来提升消费性能，唯一的方法是通过扩容消费端的实例数来提升总体的消费能力。       
- 通过扩容消费端的实例数来提升总体的消费能力。       
- 将系统降级，通过关闭一些不重要的业务，减少发送方发送的数据量，最低限度让系统还能正常运转，服务一些重要业务。
- 检查一下你的消费端，是不是消费失败导致的一条消息反复消费这种情况比较多，导致拖慢了整个系统的消费速度。