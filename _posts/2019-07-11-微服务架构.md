---
layout: post
title:  "微服务架构!"
date:   2019-07-11 16:18:23 +0100
---
微服务架构下，服务调用的几个基本组件：
- 服务描述
- 注册中心
- 服务框架
- 服务监控
- 服务追踪
- 服务治理
1. **服务描述：**
服务调用首先要解决的问题就是服务如何对外描述。例如，服务名是什么，调用该服务需要提供哪些信息，调用这个服务的返回结果是什么格式的？需要怎么解析？这些就是服务描述能够解决或者说提供的功能。     
常见的服务描述方式包括 RESTful api、XML配置和IDL等     
2. **注册中心**
对于服务的发布和订阅，我们需要一个注册中心。就是说你提供了一个服务，你需要将自己提供的服务以及地址登记到注册中心去，服务消费者则是从注册中心查询自己需要调用的服务的地址，然后发起请求。      
注册中心的工作流程一般来讲，分以下几步：     
服务提供者在启动时，根据服务发布文件中配置的发布信息向注册中心注册自己的服务。      
服务消费者在启动时，根据消费者配置文件中配置的服务信息向注册中心订阅自己所需要的服务。        
注册中心返回服务提供者地址列表给服务消费者。        
当服务提供者发生变化，比如有新服务注册或者有服务销毁，注册中心将变更通知给服务消费者。           
3.  **服务框架**
通过注册中心，我们可以拿到需要请求的服务地址，但是如果需要发起调用的话，还需要解决一下几个问题，就是服务框架中包含的内容了。         
服务通信采用什么协议？指服务提供者与服务消费者之间以什么协议进行网络通信？例如tcp ，udp， 还是http？           
数据传输采用什么方式？是同步还是异步？        
数据压缩采用什么格式？通常数据传输都会采用压缩，来减少网络传输的数据量。从而减少消耗和时间。例如JSON序列化，Java对象序列化等。        
4. **服务监控**
当服务提供者与服务消费者之间能够成功发起调用之后，你就需要对调用情况加以监控了。以了解服务是否正常。通常来讲，服务监控一般包含三个流程     
指标收集，需要将每一次服务调用的请求耗时以及成功与否收集起来，并上传至数据处理中心。      
数据处理，有了每次的调用请求的耗时以及成功与否，就可以计算每秒服务请求量，平均耗时以及成功率等指标。      
数据展示，数据收集与处理之后，就可以对外展示了，一般是通过dashboard展示在面板上。     
5. **服务追踪**
除了对服务调用情况进行监控之外，同样需要记录下服务调用经过的每一层链路，以便后续对问题进行追踪和故障定位。       
追踪的大致原理入下：      
服务消费者在发起调用前，会在本地生成一个requestid，发起调用时，会将requestid当做调用参数的一部分，传递给服务提供者。      
服务提供者接收到请求之后，记录下这个requestid，然后处理请求，如果服务提供者还需要继续请求其他服务，会自己也声称一个id，然后把这个id连同requestid当做请求参数继续向下传递，以此类推。        
通过这种层层传递的方式，不管服务调用多少层，都能够顺利的串联到本次请求的所有服务节点。从而达到服务追踪的目的。        
6. **服务治理**
服务监控能够发现问题，服务追踪能够定位到问题服务，而解决问题就选用服务治理了。服务治理就是通过一系列手段保证在各种非正常意外情况下，服务调用仍然能够正常进行下去。         
如以下几种意外情况:         
单机故障，一般我们遇到单机故障都是通过运维发现故障节点，并手动重启服务得到解决，但是当集群规模开始变大，达到上百台机器，人为就很难操作了。而服务治理可以通过一定的策略，自动摘除故障节点，达到不影响业务的高性能。          
单IDC故障，服务治理可以自动切换故障IDC的流量到其他正常IDC，避免单IDC故障导致业务受到影响。                
依赖服务不可用，例如你请求的服务里来了另一个服务，当另一个服务出现问题时，会拖垮你的 服务。而服务治理可以通过熔断，在依赖服务异常的情况下，一段时间内停止发起调用而直接返回。可以保证你的服务不被拖垮。        